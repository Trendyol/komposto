name: Build and Send APK to Slack

on:
  workflow_dispatch:
    inputs:
      slack_thread_id:
        description: 'Slack thread timestamp (thread_ts) to send the APK to'
        required: true
        type: string
      slack_channel_id:
        description: 'Slack channel ID where the thread exists (optional, defaults to UAT channel)'
        required: false
        type: string

      message:
        description: 'Custom message to send with the APK'
        required: false
        default: 'Here is the latest APK build'
        type: string

permissions:
  contents: read

jobs:
  build-and-send-apk:
    name: Build APK and Send to Slack
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: |
          ./gradlew app:assembleDebug
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_ENV

      - name: Verify APK exists
        run: |
          if [ ! -f "${{ env.APK_PATH }}" ]; then
            echo "APK file not found at ${{ env.APK_PATH }}"
            exit 1
          fi
          echo "APK found: ${{ env.APK_PATH }}"
          ls -la "${{ env.APK_PATH }}"

      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Upload APK to Slack Thread
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: files.uploadV2
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel_id: ${{ inputs.slack_channel_id || secrets.SLACK_UAT_CHANNEL_ID }}
            thread_ts: ${{ inputs.slack_thread_id }}
            initial_comment: |
              ğŸš€ *Debug APK Build Complete*
              
              ğŸ“± *File:* ${{ env.APK_NAME }}
              ğŸ”¨ *Build Type:* debug
              ğŸŒ¿ *Branch:* ${{ env.BRANCH_NAME }}
              ğŸ“ *Commit:* ${{ env.COMMIT_SHA }} - ${{ env.COMMIT_MESSAGE }}
              ğŸ‘¤ *Author:* ${{ env.COMMIT_AUTHOR }}
              â° *Built at:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
              
              ${{ inputs.message }}
            file: ${{ env.APK_PATH }}
            filename: ${{ env.APK_NAME }}
